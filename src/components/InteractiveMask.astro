---
const {
  radius = 120,
  blur = 10,
} = Astro.props;
---

<section class="blur-reveal" data-radius={radius}>
  <!-- blurred base -->
  <div class="layer layer--blur">
    <div class="content">
      <slot />
    </div>
  </div>

  <!-- sharp reveal -->
  <div class="layer layer--sharp">
    <div class="content">
      <slot />
    </div>
  </div>

  <script is:inline>
    const root = document.currentScript.closest(".blur-reveal");

    let armed = false;
    requestAnimationFrame(() => { armed = true; });

    let rafId = 0;
    let rCurrent = 0;
    const TARGET = Number(root.dataset.radius || 120);
    const DURATION = 260;

    const easeOutCubic = (t) => 1 - Math.pow(1 - t, 3);

    const setPos = (clientX, clientY) => {
      const rect = root.getBoundingClientRect();
      root.style.setProperty("--x", `${clientX - rect.left}px`);
      root.style.setProperty("--y", `${clientY - rect.top}px`);
    };

    const animateR = (toPx) => {
      cancelAnimationFrame(rafId);
      const from = rCurrent;
      const to = toPx;
      const start = performance.now();

      const tick = (now) => {
        const t = Math.min(1, (now - start) / DURATION);
        const v = from + (to - from) * easeOutCubic(t);
        rCurrent = v;
        root.style.setProperty("--r", `${v}px`);
        if (t < 1) rafId = requestAnimationFrame(tick);
      };

      rafId = requestAnimationFrame(tick);
    };

    root.addEventListener("mouseenter", (e) => {
      setPos(e.clientX, e.clientY);

      //avoid glitching here
      if (!armed) return;
      requestAnimationFrame(() => animateR(TARGET));
    });

    root.addEventListener("mousemove", (e) => setPos(e.clientX, e.clientY));
    root.addEventListener("mouseleave", () => animateR(0));
  </script>
</section>

<style>
  .blur-reveal{
    position: relative;
    width: 100%;
    background: transparent;

    --x: 50%;
    --y: 50%;
    --r: 0px;
    transition: --r 280ms cubic-bezier(.2,.8,.2,1);
  }

  .content{
    width: 100%;
    margin: 0 auto;
  }

  .layer{
    margin: 0 auto;
    padding: 22px 0;
  }
  
  .layer--sharp,
  .layer--blur{
    transition:
    -webkit-mask-image 280ms cubic-bezier(.2,.8,.2,1),
    mask-image 280ms cubic-bezier(.2,.8,.2,1);

    margin-inline: 0px;
    padding-inline: 0px;
  }
  
  .blur-reveal{ --blur-amt: 10px; }

  .layer--blur{
    filter: blur(var(--blur-amt, 10px));
    opacity: 0.95;

    /* inverse mask */
    -webkit-mask-image: radial-gradient(circle var(--r) at var(--x) var(--y),
      transparent 0%,
      transparent 65%,
      #000 72%);
    mask-image: radial-gradient(circle var(--r) at var(--x) var(--y),
      transparent 0%,
      transparent 65%,
      #000 72%);
    -webkit-mask-repeat: no-repeat;
    mask-repeat: no-repeat;
    -webkit-mask-size: 100% 100%;
    mask-size: 100% 100%;
    -webkit-mask-position: 0 0;
    mask-position: 0 0;
  }

  .layer--sharp{
    position: absolute;
    inset: 0;
    pointer-events: none;

    -webkit-mask-image: radial-gradient(circle var(--r) at var(--x) var(--y),
      rgba(0,0,0,1) 0%,
      rgba(0,0,0,1) 65%,
      rgba(0,0,0,0) 72%);
    mask-image: radial-gradient(circle var(--r) at var(--x) var(--y),
      rgba(0,0,0,1) 0%,
      rgba(0,0,0,1) 65%,
      rgba(0,0,0,0) 72%);

    -webkit-mask-repeat: no-repeat;
    mask-repeat: no-repeat;

    -webkit-mask-size: 100% 100%;
    mask-size: 100% 100%;
    -webkit-mask-position: 0 0;
    mask-position: 0 0;

    /* avoid flicker */
    will-change: -webkit-mask-image, mask-image;
  }

  @media (max-width: 760px){
  .layer{
    width: 90%;
    margin: 0 auto;
  }

  .layer--sharp,
  .layer--blur{
    padding-inline: calc(var(--blur-amt, 10px) * 2);
  }
}

</style>